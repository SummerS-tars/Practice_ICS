# Makefile for File Reading Comparison Programs
# ICS Course - Week 15 - Exercise 11 - Part 2

CC = gcc
CFLAGS = -Wall -Wextra -g -std=c99
TARGETS = MMapRead SyscallRead

# Default target
all: $(TARGETS)

# Individual targets
MMapRead: MMapRead.c
	$(CC) $(CFLAGS) -o $@ $^

SyscallRead: SyscallRead.c
	$(CC) $(CFLAGS) -o $@ $^

# Clean target
clean:
	rm -f $(TARGETS)

# Run targets for testing
run-mmap: MMapRead
	@echo "=== Running Memory-Mapped File Reading ==="
	@echo "Reading file contents using mmap() system call"
	@echo ""
	./MMapRead

run-syscall: SyscallRead
	@echo "=== Running Standard Library File Reading ==="
	@echo "Reading file contents using fread() library function"
	@echo ""
	./SyscallRead

run-both: $(TARGETS)
	@echo "=== Comparing File Reading Methods ==="
	@echo ""
	@echo "1. Memory-mapped file reading (mmap):"
	@echo "----------------------------------------"
	./MMapRead
	@echo ""
	@echo "2. Standard library file reading (fread):"
	@echo "----------------------------------------"
	./SyscallRead
	@echo ""
	@echo "=== Comparison Complete ==="

# Performance comparison
run-performance: $(TARGETS)
	@echo "=== ç²¾ç»†æ€§èƒ½æ¯”è¾ƒåˆ†æ ==="
	@echo "è¿è¡Œå¤šæ–‡ä»¶å¤§å°ã€å¤šæ¬¡è¿­ä»£çš„è¯¦ç»†æ€§èƒ½æµ‹è¯•..."
	@echo ""
	@if [ ! -f performance_test.sh ]; then \
		echo "æ€§èƒ½æµ‹è¯•è„šæœ¬ä¸å­˜åœ¨ï¼Œæ­£åœ¨åˆ›å»º..."; \
		$(MAKE) create-perf-script; \
	fi
	@if [ ! -x performance_test.sh ]; then \
		echo "è®¾ç½®è„šæœ¬æ‰§è¡Œæƒé™..."; \
		chmod +x performance_test.sh; \
	fi
	@./performance_test.sh

# Quick performance test
run-quick-perf: $(TARGETS)
	@echo "=== å¿«é€Ÿæ€§èƒ½å¯¹æ¯”æµ‹è¯• ==="
	@echo "ä½¿ç”¨å½“å‰ text.txt è¿›è¡Œç®€å•çš„æ€§èƒ½å¯¹æ¯”..."
	@echo ""
	@echo "æµ‹è¯• mmap æ–¹æ³• (10æ¬¡):"
	@for i in $$(seq 1 10); do \
		/usr/bin/time -f "ç¬¬$$iæ¬¡: %e ç§’" ./MMapRead > /dev/null 2>&1; \
	done
	@echo ""
	@echo "æµ‹è¯• syscall æ–¹æ³• (10æ¬¡):"
	@for i in $$(seq 1 10); do \
		/usr/bin/time -f "ç¬¬$$iæ¬¡: %e ç§’" ./SyscallRead > /dev/null 2>&1; \
	done

# Create performance test script
create-perf-script:
	@echo "åˆ›å»ºæ€§èƒ½æµ‹è¯•è„šæœ¬..."
	@cat > performance_test.sh << 'EOF'
#!/bin/bash

echo "=== ç²¾ç»†æ€§èƒ½æµ‹è¯•è„šæœ¬ ==="

# åˆ›å»ºä¸åŒå¤§å°çš„æµ‹è¯•æ–‡ä»¶
create_test_files() {
    echo "åˆ›å»ºæµ‹è¯•æ–‡ä»¶..."
    
    # å°æ–‡ä»¶ (1KB)
    head -c 1024 /dev/urandom | base64 > test_1kb.txt
    echo "âœ“ åˆ›å»º 1KB æµ‹è¯•æ–‡ä»¶"
    
    # ä¸­ç­‰æ–‡ä»¶ (100KB)
    head -c 102400 /dev/urandom | base64 > test_100kb.txt
    echo "âœ“ åˆ›å»º 100KB æµ‹è¯•æ–‡ä»¶"
    
    # å¤§æ–‡ä»¶ (5MB)
    head -c 5242880 /dev/urandom | base64 > test_5mb.txt
    echo "âœ“ åˆ›å»º 5MB æµ‹è¯•æ–‡ä»¶"
    echo ""
}

# è¿è¡Œæ€§èƒ½æµ‹è¯•
run_benchmark() {
    local file_size=$$1
    local test_file=$$2
    local iterations=$$3
    
    echo "æµ‹è¯•æ–‡ä»¶: $$test_file ($$file_size)"
    echo "è¿­ä»£æ¬¡æ•°: $$iterations"
    echo "----------------------------------------"
    
    # å¤‡ä»½åŸå§‹æ–‡ä»¶
    cp text.txt text.txt.backup 2>/dev/null || true
    cp $$test_file text.txt
    
    # æµ‹è¯• mmap æ–¹æ³•
    echo "æµ‹è¯• mmap æ–¹æ³•..."
    mmap_total=0
    for i in $$(seq 1 $$iterations); do
        start_time=$$(date +%s.%N)
        ./MMapRead > /dev/null 2>&1
        end_time=$$(date +%s.%N)
        duration=$$(echo "$$end_time - $$start_time" | bc -l)
        mmap_total=$$(echo "$$mmap_total + $$duration" | bc -l)
        printf "  ç¬¬ %d æ¬¡: %.6f ç§’\n" $$i $$duration
    done
    mmap_avg=$$(echo "scale=6; $$mmap_total / $$iterations" | bc -l)
    
    # æµ‹è¯• syscall æ–¹æ³•
    echo "æµ‹è¯• syscall æ–¹æ³•..."
    syscall_total=0
    for i in $$(seq 1 $$iterations); do
        start_time=$$(date +%s.%N)
        ./SyscallRead > /dev/null 2>&1
        end_time=$$(date +%s.%N)
        duration=$$(echo "$$end_time - $$start_time" | bc -l)
        syscall_total=$$(echo "$$syscall_total + $$duration" | bc -l)
        printf "  ç¬¬ %d æ¬¡: %.6f ç§’\n" $$i $$duration
    done
    syscall_avg=$$(echo "scale=6; $$syscall_total / $$iterations" | bc -l)
    
    # æ€§èƒ½æ¯”è¾ƒ
    echo ""
    echo "ğŸ“Š æ€§èƒ½æ¯”è¾ƒåˆ†æ:"
    printf "   mmap å¹³å‡:    %.6f ç§’\n" $$mmap_avg
    printf "   syscall å¹³å‡: %.6f ç§’\n" $$syscall_avg
    
    ratio=$$(echo "scale=2; $$syscall_avg / $$mmap_avg" | bc -l)
    percentage=$$(echo "scale=1; ($$syscall_avg - $$mmap_avg) / $$mmap_avg * 100" | bc -l)
    
    printf "   æ€§èƒ½æ¯”å€¼:     %.2f (syscall/mmap)\n" $$ratio
    if (( $$(echo "$$percentage > 0" | bc -l) )); then
        printf "   æ€§èƒ½å·®å¼‚:     syscall æ¯” mmap æ…¢ %.1f%%\n" $$percentage
    else
        abs_percentage=$$(echo "scale=1; -1 * $$percentage" | bc -l)
        printf "   æ€§èƒ½å·®å¼‚:     syscall æ¯” mmap å¿« %.1f%%\n" $$abs_percentage
    fi
    
    # æ¢å¤åŸå§‹æ–‡ä»¶
    cp text.txt.backup text.txt 2>/dev/null || echo "Hello World! It'\''s a text file." > text.txt
    echo ""
}

# ç³»ç»Ÿä¿¡æ¯
show_system_info() {
    echo "=== ç³»ç»Ÿä¿¡æ¯ ==="
    echo "CPUä¿¡æ¯: $$(grep '\''model name'\'' /proc/cpuinfo | head -1 | cut -d'\'':'\'' -f2 | xargs)"
    echo "å†…å­˜ä¿¡æ¯: $$(free -h | grep '\''^Mem:'\'' | awk '\''{print $$2}'\'')"
    echo "æ–‡ä»¶ç³»ç»Ÿ: $$(df -T . | tail -1 | awk '\''{print $$2}'\'')"
    echo "å†…æ ¸ç‰ˆæœ¬: $$(uname -r)"
    echo ""
}

# æ¸…ç†æµ‹è¯•æ–‡ä»¶
cleanup() {
    echo "æ¸…ç†æµ‹è¯•æ–‡ä»¶..."
    rm -f test_1kb.txt test_100kb.txt test_5mb.txt text.txt.backup
    echo "æ¸…ç†å®Œæˆ"
}

# ä¸»å‡½æ•°
main() {
    show_system_info
    create_test_files
    
    echo "=== å¼€å§‹æ€§èƒ½æµ‹è¯• ==="
    echo ""
    
    # ä¸åŒæ–‡ä»¶å¤§å°çš„æµ‹è¯•
    run_benchmark "1KB" "test_1kb.txt" 5
    run_benchmark "100KB" "test_100kb.txt" 5
    run_benchmark "5MB" "test_5mb.txt" 3
    
    echo "=== æ€§èƒ½æµ‹è¯•å®Œæˆ ==="
    echo ""
    echo "ğŸ¯ æµ‹è¯•ç»“è®º:"
    echo "â€¢ å¯¹äºå°æ–‡ä»¶(1KB)ï¼Œä¸¤ç§æ–¹æ³•æ€§èƒ½ç›¸è¿‘"
    echo "â€¢ å¯¹äºå¤§æ–‡ä»¶(5MB)ï¼Œmmap é€šå¸¸æ˜¾ç¤ºå‡ºä¼˜åŠ¿"
    echo "â€¢ mmap é¿å…äº†ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´çš„æ•°æ®æ‹·è´"
    echo "â€¢ å®é™…æ€§èƒ½å–å†³äºæ–‡ä»¶å¤§å°ã€ç³»ç»Ÿè´Ÿè½½å’Œç¡¬ä»¶é…ç½®"
    
    cleanup
}

# æ£€æŸ¥ä¾èµ–
if ! command -v bc &> /dev/null; then
    echo "é”™è¯¯: éœ€è¦å®‰è£… bc è®¡ç®—å™¨"
    echo "è¯·è¿è¡Œ: sudo apt-get install bc"
    exit 1
fi

main
EOF
	@chmod +x performance_test.sh
	@echo "âœ“ æ€§èƒ½æµ‹è¯•è„šæœ¬åˆ›å»ºå®Œæˆ"

# Clean performance test files
clean-perf:
	@echo "æ¸…ç†æ€§èƒ½æµ‹è¯•ç›¸å…³æ–‡ä»¶..."
	@rm -f test_*.txt text.txt.backup performance_test.sh
	@echo "âœ“ æ€§èƒ½æµ‹è¯•æ–‡ä»¶æ¸…ç†å®Œæˆ"

# Clean all (including performance files)
clean-all: clean clean-perf
	@echo "âœ“ æ‰€æœ‰æ–‡ä»¶æ¸…ç†å®Œæˆ"

# Check file status
check-file:
	@echo "=== File Information ==="
	@if [ -f text.txt ]; then \
		echo "File: text.txt"; \
		echo "Size: $$(stat -c%s text.txt) bytes"; \
		echo "Content:"; \
		cat text.txt; \
	else \
		echo "Error: text.txt not found!"; \
		echo "Creating sample text file..."; \
		echo "Hello World! It's a text file." > text.txt; \
		echo "Sample file created."; \
	fi

# Help target
help:
	@echo "Available targets:"
	@echo "  all              - Build all programs"
	@echo "  clean            - Remove compiled programs"
	@echo "  clean-perf       - Remove performance test files"
	@echo "  clean-all        - Remove all generated files"
	@echo "  run-mmap         - Run the memory-mapped file reading program"
	@echo "  run-syscall      - Run the standard library file reading program"
	@echo "  run-both         - Run both programs for comparison"
	@echo "  run-performance  - è¿›è¡Œç²¾ç»†çš„æ€§èƒ½æ¯”è¾ƒåˆ†æï¼ˆå¤šæ–‡ä»¶å¤§å°ã€å¤šæ¬¡æµ‹è¯•ï¼‰"
	@echo "  run-quick-perf   - å¿«é€Ÿæ€§èƒ½å¯¹æ¯”æµ‹è¯•ï¼ˆä½¿ç”¨å½“å‰æ–‡ä»¶ï¼‰"
	@echo "  create-perf-script - åˆ›å»ºæ€§èƒ½æµ‹è¯•è„šæœ¬"
	@echo "  check-file       - Check if text.txt exists and show its content"
	@echo ""
	@echo "Programs:"
	@echo "  MMapRead         - Demonstrates file reading using mmap() system call"
	@echo "  SyscallRead      - Demonstrates file reading using fread() library function"
	@echo ""
	@echo "Educational Focus:"
	@echo "  - Memory-mapped I/O vs. traditional I/O"
	@echo "  - Virtual memory concepts from CSAPP"
	@echo "  - System call interfaces"

.PHONY: all clean clean-perf clean-all run-mmap run-syscall run-both run-performance run-quick-perf create-perf-script check-file help
